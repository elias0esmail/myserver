#!/data/data/com.termux/files/usr/bin/bash

# ألوان للنص
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# مسارات أساسية لـ Termux
APACHE_DIR="$PREFIX/etc/apache2"
SSL_CONF="$APACHE_DIR/extra/httpd-ssl.conf"
SSL_CERT="$APACHE_DIR/server.crt"
SSL_KEY="$APACHE_DIR/server.key"
DOC_ROOT="/data/data/com.termux/files/home/storage/shared/htdocs"

# التحقق من حالة الخدمات
function check_status() {
    # إعادة تعيين الحالات المبدئية
    apache_status="${RED}Inactive${NC}"
    php_status="${RED}Inactive${NC}"
    mariadb_status="${RED}Inactive${NC}"
    
    # التحقق من حالة Apache
    if ps aux | grep httpd | grep -v grep  >/dev/null; then
        apache_status="${GREEN}Active${NC}"
        # التحقق من وجود وحدة PHP إذا كان Apache يعمل
        if grep -q "php_module" $APACHE_DIR/httpd.conf; then
            php_status="${GREEN}Active${NC}"
        fi
    fi
    
    # التحقق من حالة MariaDB بشكل أكثر دقة
    if pgrep  "mariadbd" >/dev/null && mysqladmin ping >/dev/null 2>&1; then
        mariadb_status="${GREEN}Active${NC}"
    fi
    
    show_status
}

# عرض حالة الخدمات
function show_status() {
    echo -e "${BLUE}=== Server Status  ===${NC}"
    echo -e "Apache:     $apache_status"
    echo -e "PHP:        $php_status"
    echo -e "MariaDB:    $mariadb_status"
    echo -e "========================${NC}"
}

# التحقق من صلاحية الشهادة
function check_cert_expiry() {
    if [ ! -f "$SSL_CERT" ]; then
        return 1
    fi
    
    expiry_date=$(openssl x509 -enddate -noout -in "$SSL_CERT" | cut -d= -f2)
    expiry_epoch=$(date -d "$expiry_date" +%s 2>/dev/null || date -j -f "%b %d %T %Y %Z" "$expiry_date" +%s)
    current_epoch=$(date +%s)
    
    if [ $((expiry_epoch - current_epoch)) -lt 2592000 ]; then
        return 1
    fi
    
    return 0
}

# إنشاء/تجديد الشهادة
function renew_ssl_cert() {
    echo -e "${YELLOW}Creating a new SSL certificate...${NC}"
    
    openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
        -keyout "$SSL_KEY" -out "$SSL_CERT" \
        -subj "/C=XX/ST=XX/L=XX/O=XX/CN=localhost" 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}Certificate renewed successfully ${NC}"
        return 0
    else
        echo -e "${RED}Failed to renew certificate ${NC}"
        return 1
    fi
}

# تشغيل الخدمات مع SSL
function start_ssl() {
    # التحقق من الشهادة
    if ! check_cert_expiry; then
        renew_ssl_cert || return 1
    fi
    
    # إعادة تشغيل Apache
    echo -e "${YELLOW}Server is restarting...${NC}"
    apachectl stop >/dev/null 2>&1
    apachectl start
    
    # تشغيل MariaDB مع زيادة وقت الانتظار
    mysqld_safe  >/dev/null 2>&1 &
    sleep 2
    
    termux-open-url "https://localhost:8443/"
    echo -e "${GREEN}Successfully started on port 8443 ${NC}"
}

# تشغيل الخدمات العادية
function start_normal() {
    apachectl stop >/dev/null 2>&1
    apachectl start
    mysqld_safe  >/dev/null 2>&1 &
    sleep 2
    termux-open-url "http://localhost:8080/"
    echo -e "${GREEN}Successfully started on port 8080 ${NC}"
}

# إيقاف الخدمات
function stop_services() {
    echo -e "${YELLOW}The server is being suspended. ${NC}"
    apachectl stop
    pkill -x mysqld
    pkill -15 "mariadbd"
    sleep 2
    echo -e "${GREEN}The server has been stopped.${NC}"
}

# دالة واحدة لتنظيف وإزالة تثبيت الخادم
uninstall_server() {
    # ألوان للنص
    local RED='\033[1;31m'
    local GREEN='\033[1;32m'
    local YELLOW='\033[1;33m'
    local BLUE='\033[1;34m'
    local NC='\033[0m' # No Color

    echo -e "${RED}=============================================="
    echo -e "          Uninstall Myserver            "
    echo -e "==============================================${NC}"
    echo -e "${YELLOW}Myserver will now be uninstalled.   ${NC}"
    echo -e "${YELLOW}All files and settings will be deleted. ${NC}"
    echo -e "${RED}This process is irreversible.!${NC}"
    echo

    read -p "Are you sure you want to continue?[y/N] " choice
    case "$choice" in 
        y|Y )
            # 1. إيقاف الخدمات
            echo -e "${BLUE}[1/6] ${YELLOW}Stop server...${NC}"
            stop_services

            # 2. إزالة الحزم
            echo -e "${BLUE}[2/6] ${YELLOW}Removing installed packages...${NC}"
            pkg remove -y php-apache mariadb composer openssl-tool wget >/dev/null 2>&1
            pkg autoremove -y >/dev/null 2>&1
            echo -e "${GREEN} Packages removed successfully  ${NC}"

            # 3. حذف ملفات التكوين
            echo -e "${BLUE}[3/6] ${YELLOW}Deleting configuration files...${NC}"
            rm -f $PREFIX/bin/myserver >/dev/null 2>&1
            echo -e "${GREEN}Configuration files deleted successfully ${NC}"

            # 4. حذف مجلد htdocs
            echo -e "${BLUE}[4/6] ${YELLOW}Deleting htdocs folder   ...${NC}"
            
            rm -rf /sdcard/htdocs >/dev/null 2>&1
            rm -rf $HOME/storage/shared/htdocs >/dev/null 2>&1
            echo -e "${GREEN}htdocs folder was deleted successfully ${NC}"

            # 6. تنظيف الملفات المؤقتة
            echo -e "${BLUE}[6/6] ${YELLOW}Cleaning temporary files   ...${NC}"
            rm -rf $HOME/.composer >/dev/null 2>&1
            rm -rf $HOME/.cache >/dev/null 2>&1
            echo -e "${GREEN}Temporary files were cleaned successfully.  ${NC}"

            echo -e "\n${GREEN}MyServer has been successfully uninstalled.!${NC}"
            ;;
        * )
            echo -e "${GREEN}The operation was canceled.${NC}"
            return 1
            ;;
    esac
}


# القائمة الرئيسية
function main_menu() {
    while true; do
        clear
        echo -e "${CYAN}====  MyServer Management  ====${NC}"
        check_status
        
        echo -e "${YELLOW}1. Start with (HTTP)"
        echo -e "2. Start with SSL (HTTPS)"
        echo -e "3. Stop Server "
        echo -e "4. Update Server status "
        echo -e "5. Uninstall"
        echo -e "0. Exit${NC}"
        echo
        
        read -p " Enter your choice  : " choice
        
        case $choice in
            1)
                start_normal
                sleep 1
                ;;
            2)
                start_ssl
                sleep 1
                ;;
            3)
                stop_services
                sleep 1
                ;;
            4)
                check_status
                sleep 1
                ;;
            5)
                uninstall_server
                sleep 1
                ;;
                
            0)
                stop_services
                echo -e "${BLUE} Good-bye!${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED} Incorrect choice !${NC}"
                sleep 1
                ;;
        esac
    done
}

# بدء البرنامج
main_menu